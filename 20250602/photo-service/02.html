<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ì‚¬ì§„ ì¸í™” ì‹œë®¬ë ˆì´ì…˜</title>
  <style>
    #preview {
      display: none;
      width: 150px;
    }

    #photo-list {
      display: flex;
      flex-wrap: wrap;
    }

    #photo-list img {
      width: 150px;
    }

    /* .delete-btn {
      pointer-events: none;
    } */
  </style>
</head>
<body>
  <h2>ğŸ“¸ ì‚¬ì§„ ì¸í™” ì„œë¹„ìŠ¤</h2>
  <p>ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”:</p>
  <input type="file" id="file-input" accept="image/*" />
  <br><br>
  <img id="preview">
  <br>
  <button id="order-btn">ğŸ“¦ ì£¼ë¬¸í•˜ê¸°</button>
  <br>
  <ul id="log"></ul>
  <div id="photo-list"></div>

  <script>
    // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
    // 2. ì•¡ì ì„ íƒ
    // 3. ë°°ì†¡ ìš”ì²­

    const fileInput = document.getElementById('file-input');
    const orderBtn = document.getElementById('order-btn');
    const log = document.getElementById('log');
    const preview = document.getElementById('preview');
    const photoList = document.getElementById('photo-list');
    const BASE_URL = 'https://web-production-6707e.up.railway.app';

    let selectedFile = null; // ì²¨ë¶€í•œ í˜„ì¬ íŒŒì¼

    loadPhotoList();

    orderBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        addLog('ì¸ì‡„í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      addLog('ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
      
      try {
        const photoId = await uploadPhoto(selectedFile);
        const orderId = await chooseFrame(photoId);
        const message = await requestDelivery(orderId);
        addLog(message);
        loadPhotoList();
      } catch (error) {
        addLog(error);
      } finally {
        addLog('fin. ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.');
      }
    });

    // Event
    fileInput.addEventListener('change', () => {
      log.innerHTML = '';

      console.log(fileInput.files)
      const file = fileInput.files[0];

      selectedFile = file;

      const reader = new FileReader();
      reader.addEventListener('load', e => {
        preview.src = e.target.result;
        preview.style.display = 'block';
      });
      reader.readAsDataURL(file);
    });

    // ì‚¬ì§„ ì‚­ì œ
    photoList.addEventListener('click', async e => {
      // console.log(e.target.dataset.filename);
      // console.log(e.target.nodeName);
      // console.log(e.target.classList.contains('delete-btn'));
      if (!e.target.classList.contains('delete-btn')) return;

      const filename = e.target.dataset.filename;

      const response = await fetch(
        `${BASE_URL}/api/photos/${filename}`,
        {
          method: 'DELETE'
        }
      );

      // ë³´ë‚´ëŠ” ì£¼ì†Œê°€ ì˜ëª»ë˜ê±°ë‚˜, ì„œë²„ê°€ ê±°ì ˆí•˜ê±°ë‚˜ ë“±ë“± ë¬¸ì œê°€ ë°œìƒí•˜ë©´..
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error);
      }

      alert('ì‚­ì œ ì™„ë£Œ');
      loadPhotoList();

      // if (response.ok) {
      //   alert('ì‚­ì œ ì™„ë£Œ');
      //   loadPhotoList();
      // } else {
      //   alert('ì‚­ì œ ì‹¤íŒ¨');
      // }
    });

    // Functions
    // 1. ì‚¬ì§„ ì—…ë¡œë“œ
    async function uploadPhoto(file) {
      const formData = new FormData(); // íƒë°°ìƒì
      formData.append('photo', file);
      // íƒë°°ìƒì(formData)ì— ì´ë¦„í‘œ('photo')ë¥¼ ë¶™ì´ê³  ë‚´ìš©ë¬¼(file)ì„ ë‹´ìŒ

      // ë³´ë‚´ê¸°
      // fetchë¡œ ì„œë²„ì— ì‹¤ì œë¡œ ìš”ì²­ ë³´ë‚´ê¸°
      // /api/upload ì£¼ì†Œë¡œ íƒë°°ìƒì ë³´ë‚´ê¸°
      // fetchëŠ” Promiseë¥¼ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
      const response = await fetch(
        `${BASE_URL}/api/upload`, // ì£¼ì†Œ
        {
          method: 'POST', // POSTëŠ” ì €ì¥(ì „ì†¡)í•˜ëŠ” ë©”ì„œë“œ
          body: formData
        }
      );

      // ë³´ë‚´ëŠ” ì£¼ì†Œê°€ ì˜ëª»ë˜ê±°ë‚˜, ì„œë²„ê°€ ê±°ì ˆí•˜ê±°ë‚˜ ë“±ë“± ë¬¸ì œê°€ ë°œìƒí•˜ë©´..
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error);
      }

      // ì„±ê³µ
      const data = await response.json();
      addLog(data.message);
      return data.photoId;
    }

    // 2. ì•¡ì ì„ íƒ
    async function chooseFrame(photoId) {
      const response = await fetch(
        `${BASE_URL}/api/choose-frame`,
        {
          method: 'POST', // ì €ì¥(ì „ì†¡)
          headers: {
            'Content-Type': 'application/json'
            // ë³´ë‚¼ ë°ì´í„°ê°€ JSONì´ë¼ê³  ì„œë²„ì— ì•Œë ¤ì¤Œ
          },
          body: JSON.stringify({ photoId })
        }
      );

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error);
      }

      // ì„±ê³µ
      const data = await response.json();
      addLog(data.message);
      return data.orderId;
    }

    // 3. ë°°ì†¡ ìš”ì²­
    async function requestDelivery(orderId) {
      const response = await fetch(
        `${BASE_URL}/api/delivery`,
        {
          method: 'POST', // ì €ì¥(ì „ì†¡)
          headers: {
            'Content-Type': 'application/json'
            // ë³´ë‚¼ ë°ì´í„°ê°€ JSONì´ë¼ê³  ì„œë²„ì— ì•Œë ¤ì¤Œ
          },
          body: JSON.stringify({ orderId })
        }
      );

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error);
      }

      // ì„±ê³µ
      const data = await response.json();
      return data.message;
    }

    async function loadPhotoList() {
      const response = await fetch(`${BASE_URL}/api/photos`);
      const data = await response.json();

      // data.photos.forEach(filename => {
      //   const figure = document.createElement('figure');
      //   const img = document.createElement('img');
      //   const btn = document.createElement('button');
      //   img.src = `${BASE_URL}/uploads/${filename}`;
      //   btn.textContent = 'ì‚­ì œ';
      //   btn.classList.add('delete-btn');
      //   btn.dataset.filename = filename;
      //   figure.dataset.filename = filename;
      //   figure.append(img, btn);
      //   photoList.append(figure);
      // });

      // let template = '';
      // data.photos.forEach(filename => {
      //   template += `
      //     <figure>
      //       <img src="${BASE_URL}/uploads/${filename}" alt="">
      //       <button class="delete-btn" data-filename="${filename}">ì‚­ì œ</button>
      //     </figure>
      //   `;
      // });
      // photoList.innerHTML = template;

      const template = [];
      data.photos.forEach(filename => {
        const str = `
          <figure>
            <img src="${BASE_URL}/uploads/${filename}" alt="">
            <button class="delete-btn" data-filename="${filename}">ì‚­ì œ</button>
          </figure>
        `;
        template.push(str);
      });
      // console.log(template.join(''));
      photoList.innerHTML = template.join('');
    }

    function addLog(text) {
      const li = document.createElement('li');
      li.textContent = text;
      log.append(li);
    }
  </script>
</body>
</html>
